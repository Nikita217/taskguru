<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TaskGuru – Мои задачи</title>
  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- Небольшие встроенные стили для визуального оформления -->
  <style>
    body {
      margin: 0; padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(120deg, #e0f1ff, #f9f9ff); /* мягкий градиент фона */
      color: #333;
    }
    .dark body {
      background: linear-gradient(120deg, #1c1c1e, #2c2c2e);
      color: #eee;
    }
    header {
      padding: 16px;
      text-align: center;
      font-size: 1.2em;
      font-weight: bold;
      position: relative;
    }
    header .profile-btn {
      position: absolute; right: 16px; top: 16px;
      background: none; border: none;
    }
    header .profile-btn img {
      width: 32px; height: 32px; border-radius: 50%;
    }
    #task-list {
      padding: 16px;
    }
    .task-card {
      background: #ffffff;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      color: #333;
    }
    .dark .task-card {
      background: #2b2b2e;
      color: #f0f0f0;
    }
    .task-card .desc {
      flex: 1; margin-left: 8px;
    }
    .task-card.completed .desc {
      text-decoration: line-through;
      opacity: 0.6;
    }
    .task-card .status-btn {
      width: 24px; height: 24px;
      border: 2px solid #666; border-radius: 50%;
      background: none;
      cursor: pointer;
    }
    .task-card.completed .status-btn {
      background: #4caf50; /* green completed */
      border-color: #4caf50;
      position: relative;
    }
    .task-card.completed .status-btn::after {
      content: '✔'; 
      color: #fff; font-size: 16px;
      position: absolute; top: -2px; left: 4px;
    }
    .add-btn {
      position: fixed;
      right: 16px; bottom: 16px;
      width: 56px; height: 56px;
      border: none; border-radius: 50%;
      background: #007aff; /* iOS blue */
      color: #fff; font-size: 36px; line-height: 0;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    /* Стиль для модального окна добавления/редактирования задачи */
    .modal-backdrop {
      display: none;
      position: fixed; top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.5);
      align-items: center; justify-content: center;
    }
    .modal {
      background: #fefefe; border-radius: 12px; padding: 16px;
      width: 90%; max-width: 320px;
    }
    .modal h2 { margin-top: 0; }
    .modal label { display: block; font-size: 0.9em; margin: 8px 0 4px; }
    .modal input, .modal textarea, .modal select {
      width: 100%; padding: 8px;
      border: 1px solid #ccc; border-radius: 8px;
      font: inherit;
    }
    .modal .actions {
      text-align: right; margin-top: 12px;
    }
    .modal .actions button {
      padding: 8px 12px; margin-left: 8px;
      border: none; border-radius: 6px;
      font: inherit; cursor: pointer;
    }
    .modal .actions .btn-cancel {
      background: none; color: #007aff;
    }
    .modal .actions .btn-save {
      background: #007aff; color: #fff;
    }
    .modal input[type="time"],
    .modal input[type="date"],
    .modal textarea {
      box-sizing: border-box;
      width: 100%;
      max-width: 100%;
    }
  </style>
</head>
<body>
  <header>
    Мои задачи
    <button class="profile-btn" id="profileBtn">
      <img src="" alt="Profile" id="profilePic"/>
    </button>
  </header>
  <main id="task-list"><!-- Список задач будет вставлен сюда --></main>
  <!-- Кнопка добавить задачу -->
  <button class="add-btn" id="addBtn">+</button>

  <!-- Модальное окно добавления/редактирования задачи -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <h2 id="modalTitle">Новая задача</h2>
      <label for="taskDesc">Описание</label>
      <textarea id="taskDesc" rows="3" placeholder="Описание задачи..."></textarea>
      <label for="taskDue">Дедлайн</label>
      <input type="date" id="taskDue" />
      <label for="taskTime">Время</label>
      <input type="time" id="taskTime" />
      <!-- Можно добавить выпадающий список категории, приоритет и т.д. -->
      <div class="actions">
        <button type="button" class="btn-cancel" id="cancelBtn">Отмена</button>
        <button type="button" class="btn-save" id="saveBtn">Сохранить</button>
      </div>
    </div>
  </div>

  <!-- Основной скрипт приложения -->
  <script>
    // Инициализация Telegram WebApp
    const tg = window.Telegram.WebApp;
    if (tg) {
      // Установка цвета темы
      document.body.classList.toggle('dark', tg.colorScheme === 'dark');
      // Получение и установка фото профиля, если доступно
      const user = tg.initDataUnsafe?.user;
      if (user && user.photo_url) {
        document.getElementById('profilePic').src = user.photo_url;
      } else {
        document.getElementById('profilePic').src = 'https://telegram.org/img/default_avatar.png';
      }
      // Опционально: Можно отобразить имя пользователя где-нибудь
      // tg.MainButton.text = `Привет, ${user.first_name}!`;
    }

    // Базовый URL API (для простоты, тот же хост)
    const API_URL = '';
    // Массив задач в памяти клиента
    let tasks = [];

    function formatDateTime(isoStr) {
      if (!isoStr) return '';
      const date = new Date(isoStr);
      const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
      const datePart = date.toLocaleDateString('ru-RU', options);
      const timePart = date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
      return `${datePart} ${timePart}`;
    }
    // Функция рендеринга списка задач
    function renderTasks() {
      const listEl = document.getElementById('task-list');
      listEl.innerHTML = ''; // очистить
      if (tasks.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color:#666;">Задач нет</p>';
        return;
      }
      tasks.forEach(task => {
        const item = document.createElement('div');
        item.className = 'task-card' + (task.status === 'Done' ? ' completed' : '');
        // Кнопка статуса
        const statusBtn = document.createElement('button');
        statusBtn.className = 'status-btn';
        statusBtn.addEventListener('click', () => toggleTaskStatus(task.id));
        item.appendChild(statusBtn);
        // Описание
        const desc = document.createElement('div');
        desc.className = 'desc';
        desc.textContent = task.description;
        item.appendChild(desc);
        // Дата дедлайна если есть
        if (task.due) {
          const dueSpan = document.createElement('span');
          dueSpan.style.fontSize = '0.8em';
          dueSpan.style.marginRight = '8px';
          dueSpan.textContent = formatDateTime(task.due);
          item.appendChild(dueSpan);
        }
        listEl.appendChild(item);
      });
    }

    // Открытие/закрытие модального окна
    const modalBackdrop = document.getElementById('modalBackdrop');
    const taskDescInput = document.getElementById('taskDesc');
    const taskDueInput = document.getElementById('taskDue');
    let editingTaskId = null;
    function openModal(editTask = null) {
      if (editTask) {
        document.getElementById('modalTitle').textContent = 'Редактировать задачу';
        taskDescInput.value = editTask.description;
        taskDueInput.value = editTask.due || '';
        editingTaskId = editTask.id;
      } else {
        document.getElementById('modalTitle').textContent = 'Новая задача';
        taskDescInput.value = '';
        taskDueInput.value = '';
        editingTaskId = null;
      }
      modalBackdrop.style.display = 'flex';
    }
    function closeModal() {
      modalBackdrop.style.display = 'none';
    }

    // Добавление новой задачи (или сохранение редактированной)
    async function saveTask() {
      const desc = taskDescInput.value.trim();
      const due = taskDueInput.value;
      if (!desc) {
        alert('Описание задачи не должно быть пустым.');
        return;
      }
      const timeInput = document.getElementById('taskTime');
      const time = timeInput ? timeInput.value : '';
      const localDateTimeStr = due && time ? `${due}T${time}` : due;
      const dueDateTime = new Date(localDateTimeStr).toISOString();
      
      const payload = {
        description: desc,
        due: dueDateTime,
        userId: tg.initDataUnsafe.user.id
      };
      console.log("userId:", tg.initDataUnsafe?.user?.id);
      let response;
      if (editingTaskId) {
        payload.id = editingTaskId;
        response = await fetch(API_URL + '/api/tasks/update', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        editingTaskId = null;
      } else {
        // Добавляем userId для связи задачи с пользователем
        
        if (!tg.initDataUnsafe?.user?.id) {
          alert('Ошибка: не удалось получить userId из Telegram');
          return;
        }
        payload.userId = tg.initDataUnsafe.user.id;
        response = await fetch(API_URL + '/api/tasks', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      }
      if (response.ok) {
        const data = await response.json();
        if (data) {
          await loadTasks(); // перезагрузить список задач
        }
      } else {
        console.error('Ошибка сохранения задачи', response.status);
      }
      closeModal();
    }

    // Переключение статуса задачи (выполнена/не выполнена)
    async function toggleTaskStatus(taskId) {
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;
      const newStatus = task.status === 'Done' ? 'Pending' : 'Done';
      const resp = await fetch(API_URL + '/api/tasks/complete', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: taskId, status: newStatus })
      });
      if (resp.ok) {
        task.status = newStatus;
        renderTasks();
      } else {
        console.error('Не удалось обновить статус задачи');
      }
    }

    // Загрузка задач с сервера
    async function loadTasks() {
      const userId = tg.initDataUnsafe?.user?.id;
      if (!userId) {
        console.warn('User ID not found, cannot load tasks');
        return;
      }
      const resp = await fetch(API_URL + '/api/tasks?userId=' + userId);
      if (resp.ok) {
        const data = await resp.json();
        tasks = data.tasks || [];
        renderTasks();
      } else {
        console.error('Ошибка загрузки задач');
      }
    }

    // Обработчики UI
    document.getElementById('addBtn').addEventListener('click', () => openModal());
    document.getElementById('cancelBtn').addEventListener('click', closeModal);
    document.getElementById('saveBtn').addEventListener('click', saveTask);
    // Профиль - можно открыть профиль/статистику по нажатию (реализуется отдельно)
    document.getElementById('profileBtn').addEventListener('click', () => {
      alert('Открыть профиль пользователя (в разработке)');
      // Здесь можно реализовать переход на экран профиля
    });

    // При загрузке сразу получить список задач
    loadTasks();
  </script>

<!-- Вкладки -->
<div style="display: flex; justify-content: center; gap: 10px; margin: 16px;">
  <button onclick="setTab('all')" class="tab-btn" id="tab-all">Все</button>
  <button onclick="setTab('today')" class="tab-btn" id="tab-today">Сегодня</button>
  <button onclick="setTab('done')" class="tab-btn" id="tab-done">Выполненные</button>
</div>

<!-- Модальное окно создания и редактирования задачи -->
<div id="modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:#00000088; align-items:center; justify-content:center; z-index:1000;">
  <div style="background:#fff; padding:20px; border-radius:12px; max-width:90%; width:300px;">
    <div id="stepContent"></div>
  </div>
</div>

<style>
  .tab-btn { padding: 8px 14px; border-radius: 12px; border: none; background: #ddd; }
  .tab-btn.active { background: #007bff; color: white; }
  .fade-out { opacity: 0; transform: translateX(20px); transition: 0.4s; }
</style>

<script>
  let currentTab = 'all';
  let step = 1;
  let currentInput = {};
  let editIndex = null;

  function setTab(tab) {
    currentTab = tab;
    ['all','today','done'].forEach(t => document.getElementById('tab-' + t).classList.remove('active'));
    document.getElementById('tab-' + tab).classList.add('active');
    renderTasks();
  }

  function openModal(create = true, index = null) {
    step = 1;
    currentInput = {};
    editIndex = index;
    modal.style.display = 'flex';
    if (!create && index !== null) {
      currentInput = { ...tasks[index] };
      step = 4;
    }
    showStep();
  }

  function showStep() {
    const el = document.getElementById('stepContent');
    if (step === 1) {
      el.innerHTML = '<input placeholder="Задача" value="'+(currentInput.text||'')+'" onchange="currentInput.text=this.value" /><br><button onclick="step=2;showStep()">Далее</button>';
    } else if (step === 2) {
      el.innerHTML = '<input type="date" onchange="currentInput.date=this.value" /><br><button onclick="step=3;showStep()">Далее</button>';
    } else if (step === 3) {
      el.innerHTML = '<input type="time" onchange="currentInput.time=this.value" /><br><button onclick="saveTask()">Сохранить</button>';
    } else if (step === 4) {
      el.innerHTML = \`
        <input value="\${currentInput.text}" onchange="currentInput.text=this.value" /><br>
        <input type="datetime-local" value="\${currentInput.due}" onchange="currentInput.due=this.value" /><br>
        <button onclick="updateTask()">Сохранить</button>\`;
    }
  }

  function saveTask() {
    const due = currentInput.date + 'T' + currentInput.time;
    tasks.push({ text: currentInput.text, due, done: false });
    modal.style.display = 'none';
    renderTasks();
  }

  function updateTask() {
    if (editIndex !== null) {
      tasks[editIndex] = currentInput;
      modal.style.display = 'none';
      renderTasks();
    }
  }

  function toggleDone(i, el) {
    tasks[i].done = true;
    el.classList.add('fade-out');
    setTimeout(renderTasks, 400);
  }

  function renderTasks() {
    const now = new Date().toISOString().split('T')[0];
    const list = document.getElementById('task-list');
    list.innerHTML = '';
    tasks.filter((t, i) => {
      if (currentTab === 'today') return t.due.startsWith(now) && !t.done;
      if (currentTab === 'done') return t.done;
      return !t.done;
    }).sort((a,b)=>new Date(a.due)-new Date(b.due)).forEach((task, i) => {
      const div = document.createElement('div');
      div.className = 'task-card' + (task.done ? ' done' : '');
      div.innerHTML = \`
        <span class="desc">\${task.text}</span>
        <span style="font-size:0.8em">\${task.due.replace('T',' ').slice(0,16)}</span>
      \`;
      div.onclick = () => openModal(false, i);
      if (!task.done) div.ondblclick = () => toggleDone(i, div);
      list.appendChild(div);
    });
  }

  // Пример задач
  const tasks = [
    { text: 'Уведомление 1', due: '2025-05-14T16:00', done: false },
    { text: 'Уведомление 2', due: '2025-05-14T17:00', done: true }
  ];
  setTab('all');
</script>

</body>

</html>
